<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡§Æ‡§Ç‡§°‡•Ä GOLD</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f4f4; --card:#ffffff; --text:#111; --muted:#444;
  --green:#0f9d58; --border:#ddd; --gold:#FFD54A;
}
body.dark{
  --bg:#0d0f12; --card:#111; --text:#fff; --muted:#bfc6cc;
  --green:#0f9d58; --border:#2a2f36; --gold:#FFD54A;
}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);}

#splash{
  position:fixed; inset:0; background:var(--green); color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:28px; font-weight:900; z-index:9999;
}

header{
  background:var(--green); padding:12px 12px;
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
}
.brand{font-weight:900;letter-spacing:.5px;font-size:22px;line-height:1; white-space:nowrap;}
.brand .mandi{color:#fff;}
.brand .gold{color:var(--gold);text-shadow:0 1px 0 rgba(0,0,0,.3);}
.actions{display:flex;gap:8px;align-items:center;}
.btnSmall{
  background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25);
  color:#fff; padding:6px 10px; border-radius:999px;
  cursor:pointer; font-size:12px; font-weight:800;
}

.tab{display:none;padding:12px;padding-bottom:96px;}
.tab.active{display:block;}

/* ‚úÖ Premium section card (NO soft tint backgrounds) */
.section{
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--card);
  margin:14px 0;
  overflow:hidden;
}
.sectionHead{
  padding:10px 12px;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:8px;
  color:#fff;
}
.gradA{background:linear-gradient(90deg, #0f9d58, #1dbf73);}
.gradB{background:linear-gradient(90deg, #111827, #374151);}
.gradC{background:linear-gradient(90deg, #d97706, #f59e0b);}
.gradD{background:linear-gradient(90deg, #2563eb, #60a5fa);}
.gradE{background:linear-gradient(90deg, #7c3aed, #a78bfa);}
.sectionBody{padding:12px;}

.filters{background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px;margin:10px 0;}
.seg{display:flex;gap:8px;margin-bottom:10px;}
.seg button{
  flex:1; padding:10px; border-radius:10px; cursor:pointer;
  border:1px solid var(--border); background:var(--bg); color:var(--text); font-weight:800;
}
.seg button.active{background:var(--green);color:#fff;border-color:var(--green);}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
select, input{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
  background:var(--bg);color:var(--text);font-weight:700;
  box-sizing:border-box;
}

/* table (‚úÖ full-width look) */
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:0;overflow:visible;}
th,td{border:1px solid var(--border);padding:9px;font-size:13.5px;text-align:center;}
td{font-weight:600;}
th{background:var(--green);color:#fff;border-color:rgba(255,255,255,.2);font-weight:800;}

.card{background:var(--card);padding:10px;border-radius:10px;margin:10px 0;border:1px solid var(--border);}
.row{display:flex;gap:10px;align-items:center;cursor:pointer;}
.row img{width:30%;height:80px;object-fit:cover;border-radius:8px;background:#ccc;}
.row .text{width:70%;font-weight:700;font-size:14px}
.detail{display:none;font-size:14px;margin-top:8px;color:var(--muted);white-space:pre-wrap;font-weight:600;line-height:1.5;}

.bottom{
  position:fixed;bottom:0;left:0;right:0;
  display:flex;justify-content:space-around;
  background:var(--green); padding:6px 0;
}
.bottom button{
  flex:1;border:0;background:none;color:#fff;
  display:flex;flex-direction:column;align-items:center;gap:2px;
  font-size:11px;cursor:pointer;opacity:.92;
}
.bottom .icon{font-size:22px;line-height:1;}
.bottom button.active{opacity:1;color:#ffe082;font-weight:900;}

.trendLink{cursor:pointer;text-decoration:underline;font-weight:800;}

.modal{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:99999;
}
.modal .box{
  width:min(920px,92vw); max-height:86vh; overflow:auto;
  background:var(--bg); border:1px solid var(--border); border-radius:14px;
  padding:12px;
}
.modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; flex-wrap:wrap;}
.closeBtn{
  background:var(--card); border:1px solid var(--border); color:var(--text);
  padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800;
}
.small{font-size:12px;color:var(--muted);}
iframe{width:100%;height:240px;border-radius:12px;border:0;}
canvas{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px;}

#toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:88px; z-index:999999;
  background:var(--card); color:var(--text);
  border:1px solid var(--border);
  padding:10px 12px; border-radius:999px;
  display:none; font-weight:900; box-shadow:0 6px 20px rgba(0,0,0,.2);
}

/* ticker */
.tickerWrap{
  margin:10px 0 6px 0;
  border:1px solid var(--border);
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  align-items:center;
}
.tickerLabel{
  background:var(--green);
  color:var(--gold);
  font-weight:900;
  padding:10px 12px;
  white-space:nowrap;
}
.marquee{position:relative;overflow:hidden;width:100%;padding:10px 0;}
.track{display:inline-block;white-space:nowrap;will-change:transform;animation: scroll 18s linear infinite;}
.track span{margin:0 14px;font-weight:700;color:var(--text);}
@keyframes scroll{0%{transform:translateX(0);}100%{transform:translateX(-50%);}}

/* stats */
.statsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.statCard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;}
.statNum{font-size:20px;font-weight:900;line-height:1.2;}
.statLabel{font-size:12px;color:var(--muted);font-weight:700;margin-top:4px;}

/* socials */
.socialGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.socialBtn{
  display:flex;align-items:center;justify-content:center;
  padding:10px;border-radius:10px;text-decoration:none;
  font-weight:900;color:#fff;
}
.fb{background:#1877F2;}
.wa{background:#25D366;}
.yt{background:#FF0000;}
.tg{background:#229ED9;}

/* ‚úÖ Total rows found badge */
.rowsBadge{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background:var(--bg);
  border:1px dashed var(--border);
  border-radius:12px;
  padding:10px 12px;
  margin:10px 0 0 0;
  font-weight:800;
}
.rowsBadge b{font-weight:900;}

/* ‚úÖ Added features styles (Favorites/Compare/Load more) */
.pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 10px;border-radius:999px;
  border:1px solid var(--border);
  background:var(--bg);
  cursor:pointer;
  font-weight:900;font-size:12px;
}
.pill .x{opacity:.8;font-weight:900;}
.pill:hover{border-color:var(--green);}
.miniBtn{
  padding:8px 10px;border-radius:10px;border:1px solid var(--border);
  background:var(--bg);color:var(--text);cursor:pointer;font-weight:900;
}
.miniBtn.primary{background:var(--green);border-color:var(--green);color:#fff;}
.inlineRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

/* ‚úÖ Onboarding */
.onboardBox{
  width:min(560px,92vw);
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}
.onboardTitle{font-weight:900;font-size:18px;margin-bottom:8px;}
.onboardList{margin:0;padding-left:18px;color:var(--muted);font-weight:700;line-height:1.6;}
.onboardFooter{display:flex;justify-content:flex-end;margin-top:12px;}
</style>
</head>

<body>
<div id="splash">üåæ ‡§Æ‡§Ç‡§°‡•Ä GOLD</div>
<div id="toast"></div>

<header>
  <div class="brand"><span class="mandi">‡§Æ‡§Ç‡§°‡•Ä</span> <span class="gold">GOLD</span></div>
  <div class="actions">
    <button class="btnSmall" onclick="enableAlerts()">üîî Alerts</button>
    <button class="btnSmall" onclick="toggleTheme()">üåó Theme</button>
  </div>
</header>

<div id="bhav" class="tab active"></div>
<div id="news" class="tab"></div>
<div id="trend" class="tab"></div>
<div id="weather" class="tab"></div>
<div id="video" class="tab"></div>

<div class="bottom">
  <button id="btn-bhav" onclick="openTab('bhav')"><div class="icon">üåæ</div><div>Bhav</div></button>
  <button id="btn-news" onclick="openTab('news')"><div class="icon">üì∞</div><div>News</div></button>
  <button id="btn-trend" onclick="openTab('trend')"><div class="icon">üìà</div><div>Teji/Mandi</div></button>
  <button id="btn-weather" onclick="openTab('weather')"><div class="icon">üå¶Ô∏è</div><div>Mausam</div></button>
  <button id="btn-video" onclick="openTab('video')"><div class="icon">üé•</div><div>Video</div></button>
</div>

<!-- ‚úÖ Onboarding Modal (1-time) -->
<div id="onboardModal" class="modal" style="z-index:999999;">
  <div class="onboardBox">
    <div class="onboardTitle">üëã Welcome to ‡§Æ‡§Ç‡§°‡•Ä GOLD</div>
    <ul class="onboardList">
      <li><b>Bhav:</b> Select state ‚Üí mandi</li>
      <li><b>Trend:</b> Trend pe click</li>
      <li><b>Compare:</b> Compare ON ‚Üí mandi/fasal choose</li>
    </ul>
    <div class="onboardFooter">
      <button class="miniBtn primary" onclick="closeOnboarding()">Got it</button>
    </div>
  </div>
</div>

<!-- Trend Modal -->
<div id="trendModal" class="modal">
  <div class="box">
    <div class="modalTop">
      <div style="font-weight:900;font-size:16px;" id="trendTitle">üìä Trend</div>

      <div class="inlineRow" style="margin-left:auto;">
        <!-- ‚úÖ Compare Controls -->
        <label class="pill" style="cursor:default;">
          <input id="cmpEnable" type="checkbox" style="width:auto;margin:0 6px 0 0;"> Compare
        </label>
        <select id="cmpMandi" style="min-width:160px;display:none;">
          <option value="">Select Compare Mandi</option>
        </select>
        <select id="cmpFasal" style="min-width:160px;display:none;">
          <option value="">Select Compare Fasal</option>
        </select>
      </div>

      <button class="closeBtn" onclick="closeTrend()">‚úñ Close</button>
    </div>

    <!-- ‚úÖ Trend insights -->
    <div class="card" style="margin:0 0 10px 0;">
      <div style="font-weight:900;margin-bottom:8px;">üìå Insights</div>
      <div class="statsGrid">
        <div class="statCard">
          <div class="statNum" id="ins7">‚Äî</div>
          <div class="statLabel">7-day Change</div>
        </div>
        <div class="statCard">
          <div class="statNum" id="insHL">‚Äî</div>
          <div class="statLabel">30-day High / Low</div>
        </div>
        <div class="statCard">
          <div class="statNum" id="insAvg">‚Äî</div>
          <div class="statLabel">Avg Modal</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin:0 0 10px 0;">
      <div style="font-weight:900;margin-bottom:6px;">Last 7 Days (Modal)</div>
      <canvas id="chart7" height="120"></canvas>
    </div>
    <div class="card" style="margin:0;">
      <div style="font-weight:900;margin-bottom:6px;">Last 30 Days (Modal)</div>
      <canvas id="chart30" height="120"></canvas>
    </div>
  </div>
</div>

<!-- Video Modal -->
<div id="videoModal" class="modal">
  <div class="box">
    <div class="modalTop">
      <div style="font-weight:900;font-size:16px;" id="videoTitle">üé• Video</div>
      <button class="closeBtn" onclick="closeVideo()">‚úñ Close</button>
    </div>
    <div id="videoFrameWrap"></div>
  </div>
</div>

<script>
/* THEME */
document.body.classList.remove("dark");
if(localStorage.theme === "dark") document.body.classList.add("dark");
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.theme = document.body.classList.contains("dark") ? "dark" : "light";
}

/* SPLASH */
(function(){
  const seen = localStorage.getItem("mg_splash_seen");
  const s = document.getElementById("splash");
  if(seen){ s.style.display="none"; }
  else{
    setTimeout(()=>{ s.style.display="none"; localStorage.setItem("mg_splash_seen","1"); },2000);
  }
})();

/* CONFIG */
const SHEET_ID="1SX6L73WQ57OJ0tUUJwEjmSVgn3LjJLe54B4Lp_JN2SE";

/* TABS */
function closeVideo(){
  document.getElementById("videoFrameWrap").innerHTML = "";
  document.getElementById("videoModal").style.display = "none";
}
function openTab(t){
  const current = localStorage.tab || "bhav";
  if(current === "video" && t !== "video"){ closeVideo(); }

  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById(t).classList.add('active');

  document.querySelectorAll('.bottom button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+t).classList.add('active');

  localStorage.tab=t;
}
if(localStorage.tab) openTab(localStorage.tab); else openTab("bhav");

/* TOAST + ALERTS (in-app only) */
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  setTimeout(()=>t.style.display="none", 4500);
}
function enableAlerts(){
  localStorage.setItem("mg_alerts_enabled","1");
  showToast("‚úÖ Alerts ON (In-app)");
}
function fireBhavUpdateAlert(){
  const enabled = localStorage.getItem("mg_alerts_enabled")==="1";
  const msg="‡§®‡§Ø‡•á ‡§≠‡§æ‡§µ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡§Ç, ‡§Ö‡§™‡§®‡•Ä ‡§Æ‡§Ç‡§°‡•Ä ‡§ï‡•á ‡§®‡§è üåæ ‡§≠‡§æ‡§µ ‡§ú‡§æ‡§®‡§ø‡§è ‡§Ö‡§≠‡•Ä";
  if(enabled){
    showToast("üîî " + msg);
    if(navigator.vibrate) navigator.vibrate([120, 60, 120]);
  }
}

/* ‚úÖ Better load + cache + error UI */
async function loadRaw(sheet){
  const r = await fetch(`https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheet)}`, { cache:"no-store" });
  if(!r.ok) throw new Error("HTTP " + r.status);
  return r.json();
}
async function loadCached(sheet){
  const key="mg_cache_"+sheet;
  const cached = localStorage.getItem(key);
  if(cached){
    loadRaw(sheet).then(d=>localStorage.setItem(key, JSON.stringify(d))).catch(()=>{});
    try{ return JSON.parse(cached); }catch(e){}
  }
  const d = await loadRaw(sheet);
  localStorage.setItem(key, JSON.stringify(d));
  return d;
}
async function load(sheet){
  try{
    return await loadCached(sheet);
  }catch(e){
    showToast("‚ö†Ô∏è Data load failed. Internet check karo.");
    return [];
  }
}

/* HELPERS */
function unique(arr){return [...new Set(arr.filter(x=>x!==undefined && x!==null && x!==""))];}
function toISO(dateStr){
  const d=new Date((dateStr||"").toString().trim());
  if(isNaN(d.getTime())) return "";
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function getField(obj, names){
  const keys = Object.keys(obj||{});
  for(const name of names){
    const k = keys.find(x => x.toLowerCase() === name.toLowerCase());
    if(k) return obj[k];
  }
  return "";
}
function escapeHtml(str){
  return (str||"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function toNum(x){
  const n = Number((x||"").toString().replace(/[^\d.]/g,""));
  return isNaN(n) ? 0 : n;
}

/* ‚úÖ Trend format: Teji = green ‚ñ≤ +200, Mandi = red ‚ñº -200 */
function formatTrend(val){
  const raw=(val||"").toString().trim();
  const s=raw.toLowerCase();
  if(!s) return "";
  const n = (s.match(/-?\d+/)||[""])[0];
  if(s.startsWith("teji")){
    const num = n || "";
    return `<span style="color:#0f9d58;font-weight:900;">‚ñ≤ +${num}</span>`;
  }
  if(s.startsWith("mandi")){
    const num = n || "";
    return `<span style="color:#e53935;font-weight:900;">‚ñº -${num}</span>`;
  }
  if(s.startsWith("neutral")) return `<span style="color:#f59e0b;font-weight:900;">‚óè Neutral</span>`;
  return escapeHtml(raw);
}

function openExclusive(group, id){
  document.querySelectorAll(`.${group}`).forEach(el=>{
    if(el.id !== id) el.style.display="none";
  });
  const t=document.getElementById(id);
  if(!t) return;
  t.style.display = (t.style.display==="block") ? "none" : "block";
}

/* TICKER */
function tickerHTML(items){
  if(!items || items.length===0) return "";
  const line = items.map(x=>`<span>‚Ä¢ ${escapeHtml(x)}</span>`).join("");
  return `
    <div class="tickerWrap">
      <div class="tickerLabel">Latest</div>
      <div class="marquee">
        <div class="track">${line}${line}</div>
      </div>
    </div>
  `;
}

/* STATS COUNTER (3 sec) */
function animateCount(el, target){
  if(!el) return;
  let cur = 0;
  const duration = 3000, fps = 30;
  const totalSteps = Math.max(1, Math.floor((duration/1000)*fps));
  const stepVal = target / totalSteps;

  const timer = setInterval(()=>{
    cur += stepVal;
    if(cur >= target){
      cur = target;
      clearInterval(timer);
    }
    el.textContent = Math.round(cur);
  }, Math.round(1000/fps));
}

/* ‚úÖ Onboarding */
function closeOnboarding(){
  localStorage.setItem("mg_onboard_seen","1");
  document.getElementById("onboardModal").style.display="none";
}
function maybeShowOnboarding(){
  const seen = localStorage.getItem("mg_onboard_seen")==="1";
  if(!seen){
    document.getElementById("onboardModal").style.display="flex";
  }
}

/* ‚úÖ Favorites (Mandi/Fasal) */
let bhavAll=[];
function favKey(){ return "mg_favs_v1"; }
function getFavs(){ return JSON.parse(localStorage.getItem(favKey())||"[]"); }
function setFavs(list){ localStorage.setItem(favKey(), JSON.stringify(list)); }
function addFav(type, value){
  const v=(value||"").toString().trim();
  if(!v) return;
  const favs=getFavs();
  if(!favs.some(x=>x.type===type && x.value===v)){
    favs.unshift({type,value:v});
    setFavs(favs.slice(0,12));
    showToast("‚≠ê Saved to Favorites");
    renderFavs();
  }
}
function removeFav(type, value){
  const favs=getFavs().filter(x=>!(x.type===type && x.value===value));
  setFavs(favs);
  renderFavs();
}
function renderFavs(){
  const wrap=document.getElementById("favWrap");
  if(!wrap) return;
  const favs=getFavs();
  if(!favs.length){
    wrap.innerHTML = `<div class="small">No favorites yet. Select mandi/fasal and tap ‚≠ê Save.</div>`;
    return;
  }
  wrap.innerHTML = `
    <div class="pillRow">
      ${favs.map(f=>`
        <div class="pill" data-type="${escapeHtml(f.type)}" data-val="${escapeHtml(f.value)}">
          ${f.type==="mandi" ? "üìç" : "üåæ"} ${escapeHtml(f.value)}
          <span class="x" data-x="1" title="Remove">‚úñ</span>
        </div>
      `).join("")}
    </div>
  `;
  wrap.querySelectorAll(".pill").forEach(p=>{
    p.onclick=(e)=>{
      const type=p.dataset.type, val=p.dataset.val;
      if(e.target && e.target.dataset && e.target.dataset.x==="1"){
        removeFav(type,val);
        return;
      }
      if(type==="mandi"){
        setBhavMode("mandiWise");
        const mwState=document.getElementById("mwState");
        const mwMandi=document.getElementById("mwMandi");
        const row = bhavAll.find(r=>r.Mandi===val);
        if(row && row.State){
          mwState.value=row.State;
          mwState.onchange();
        }
        setTimeout(()=>{
          mwMandi.value=val;
          mwMandi.onchange();
        }, 0);
      }else if(type==="fasal"){
        setBhavMode("fasalWise");
        const fwFasal=document.getElementById("fwFasal");
        fwFasal.value=val;
        fwFasal.onchange();
      }
      showToast("‚≠ê Favorite applied");
    };
  });
}

/* YOUTUBE */
function ytId(url){
  if(!url) return "";
  const u=url.toString().trim();
  if(u.includes("youtu.be/")) return u.split("youtu.be/")[1].split("?")[0].split("&")[0];
  if(u.includes("watch?v=")) return u.split("watch?v=")[1].split("&")[0];
  if(u.includes("/shorts/")) return u.split("/shorts/")[1].split("?")[0].split("&")[0];
  return "";
}
function openVideo(id, title){
  document.getElementById("videoTitle").textContent = "üé• " + (title || "Video");
  const src = `https://www.youtube.com/embed/${id}?autoplay=1&playsinline=1&rel=0`;
  document.getElementById("videoFrameWrap").innerHTML =
    `<iframe src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
  document.getElementById("videoModal").style.display="flex";
}

/* TREND CHART */
let chart7Inst=null, chart30Inst=null;
let currentTrendBase={mandi:"", fasal:""};

function closeTrend(){
  document.getElementById("trendModal").style.display="none";
  if(chart7Inst){chart7Inst.destroy(); chart7Inst=null;}
  if(chart30Inst){chart30Inst.destroy(); chart30Inst=null;}
  const cmpEnable=document.getElementById("cmpEnable");
  const cmpMandi=document.getElementById("cmpMandi");
  const cmpFasal=document.getElementById("cmpFasal");
  if(cmpEnable){ cmpEnable.checked=false; }
  if(cmpMandi){ cmpMandi.style.display="none"; cmpMandi.value=""; }
  if(cmpFasal){ cmpFasal.style.display="none"; cmpFasal.value=""; }
}
function lastN(arr,n){return arr.slice(Math.max(0, arr.length-n));}
function getSeries(mandi, fasal){
  return bhavAll
    .filter(r => (!mandi || r.Mandi===mandi) && (!fasal || r.Fasal===fasal))
    .sort((a,b)=> (a.DateISO||"").localeCompare(b.DateISO||""));
}

function updateTrendInsights(baseRows){
  const ins7 = document.getElementById("ins7");
  const insHL = document.getElementById("insHL");
  const insAvg = document.getElementById("insAvg");
  if(!ins7 || !insHL || !insAvg) return;

  const rows7 = lastN(baseRows, 7);
  const rows30 = lastN(baseRows, 30);

  if(rows7.length >= 2){
    const first = toNum(rows7[0].Modal);
    const last = toNum(rows7[rows7.length-1].Modal);
    const diff = last - first;
    const sign = diff >= 0 ? "+" : "";
    ins7.innerHTML = `<span style="color:${diff>=0 ? "#0f9d58" : "#e53935"};font-weight:900;">${sign}${Math.round(diff)}</span>`;
  }else{
    ins7.textContent = "‚Äî";
  }

  if(rows30.length){
    const vals = rows30.map(r=>toNum(r.Modal)).filter(v=>v>0);
    if(vals.length){
      const hi = Math.max(...vals);
      const lo = Math.min(...vals);
      insHL.textContent = `${Math.round(hi)} / ${Math.round(lo)}`;
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      insAvg.textContent = `${Math.round(avg)}`;
    }else{
      insHL.textContent = "‚Äî";
      insAvg.textContent = "‚Äî";
    }
  }else{
    insHL.textContent = "‚Äî";
    insAvg.textContent = "‚Äî";
  }
}

function buildCharts(baseRows, cmpRows){
  updateTrendInsights(baseRows);

  const rows7 = lastN(baseRows, 7);
  const rows30 = lastN(baseRows, 30);

  let cmpMap = null;
  if(cmpRows && cmpRows.length){
    cmpMap = new Map(cmpRows.map(r=>[r.Date, toNum(r.Modal)]));
  }
  const labels7 = rows7.map(r=>r.Date);
  const labels30 = rows30.map(r=>r.Date);

  const base7 = rows7.map(r=>toNum(r.Modal));
  const base30 = rows30.map(r=>toNum(r.Modal));

  const cmp7 = (cmpMap ? labels7.map(d=> (cmpMap.has(d) ? cmpMap.get(d) : null)) : null);
  const cmp30 = (cmpMap ? labels30.map(d=> (cmpMap.has(d) ? cmpMap.get(d) : null)) : null);

  const ctx7 = document.getElementById("chart7").getContext("2d");
  const ctx30 = document.getElementById("chart30").getContext("2d");

  if(chart7Inst){ chart7Inst.destroy(); chart7Inst=null; }
  if(chart30Inst){ chart30Inst.destroy(); chart30Inst=null; }

  const ds7 = [
    {data: base7, borderColor:"#0f9d58", backgroundColor:"rgba(15,157,88,0.12)", tension:0.25, fill:true}
  ];
  const ds30 = [
    {data: base30, borderColor:"#FFD54A", backgroundColor:"rgba(255,213,74,0.12)", tension:0.25, fill:true}
  ];

  if(cmp7){
    ds7.push({data: cmp7, borderColor:"#2563eb", backgroundColor:"rgba(37,99,235,0.08)", tension:0.25, fill:false});
  }
  if(cmp30){
    ds30.push({data: cmp30, borderColor:"#7c3aed", backgroundColor:"rgba(124,58,237,0.08)", tension:0.25, fill:false});
  }

  chart7Inst = new Chart(ctx7,{ type:"line", data:{labels: labels7, datasets: ds7}, options:{responsive:true,plugins:{legend:{display:false}}} });
  chart30Inst = new Chart(ctx30,{ type:"line", data:{labels: labels30, datasets: ds30}, options:{responsive:true,plugins:{legend:{display:false}}} });
}

function openTrend(mandi, fasal){
  currentTrendBase = {mandi: mandi||"", fasal: fasal||""};
  document.getElementById("trendTitle").textContent = `üìä Trend: ${mandi || ""}${fasal ? " | "+fasal : ""}`;

  const baseRows = getSeries(currentTrendBase.mandi, currentTrendBase.fasal);
  buildCharts(baseRows, null);

  const cmpMandi=document.getElementById("cmpMandi");
  const cmpFasal=document.getElementById("cmpFasal");
  const cmpEnable=document.getElementById("cmpEnable");

  if(cmpMandi && cmpFasal && cmpEnable){
    cmpMandi.innerHTML = `<option value="">Select Compare Mandi</option>` + unique(bhavAll.map(r=>r.Mandi)).map(m=>`<option>${escapeHtml(m)}</option>`).join("");
    cmpFasal.innerHTML = `<option value="">Select Compare Fasal</option>` + unique(bhavAll.map(r=>r.Fasal)).map(f=>`<option>${escapeHtml(f)}</option>`).join("");

    cmpEnable.onchange=()=>{
      const on = cmpEnable.checked;
      cmpMandi.style.display = on ? "block" : "none";
      cmpFasal.style.display = on ? "block" : "none";
      if(!on){
        cmpMandi.value=""; cmpFasal.value="";
        buildCharts(getSeries(currentTrendBase.mandi, currentTrendBase.fasal), null);
      }else{
        buildCharts(getSeries(currentTrendBase.mandi, currentTrendBase.fasal), null);
      }
    };

    function refreshCompare(){
      if(!cmpEnable.checked) return;
      const cm = cmpMandi.value || "";
      const cf = cmpFasal.value || "";
      const cmpRows = (cm || cf) ? getSeries(cm, cf) : null;
      buildCharts(getSeries(currentTrendBase.mandi, currentTrendBase.fasal), cmpRows);
    }
    cmpMandi.onchange=refreshCompare;
    cmpFasal.onchange=refreshCompare;
  }

  document.getElementById("trendModal").style.display="flex";
}

/* ‚úÖ Total rows found */
function setRowsFound(n){
  const badge = document.getElementById("rowsBadge");
  const count = document.getElementById("rowsCount");
  if(!badge || !count) return;
  badge.style.display = "flex";
  count.textContent = n;
}

/* ‚úÖ Pagination: show first 50 rows + Load more */
const PAGE_SIZE = 50;
let currentRowsAll = [];
let currentPage = 1;
let currentMode = "mandiWise";

function resetPagination(rows, mode){
  currentRowsAll = rows || [];
  currentMode = mode || "mandiWise";
  currentPage = 1;
  drawTablePage();
}
function loadMore(){
  currentPage += 1;
  drawTablePage(true);
}
function getPagedRows(){
  const end = currentPage * PAGE_SIZE;
  return currentRowsAll.slice(0, end);
}
function drawTablePage(scrollKeep){
  const rows = getPagedRows();
  setRowsFound(currentRowsAll.length);

  if(currentMode==="mandiWise"){
    drawMandiWise(rows);
  }else{
    drawFasalWise(rows);
  }
  if(scrollKeep){
    // do nothing
  }
}

/* BHAV UI */
function bhavUI(tickerBlock){
  return `
    ${tickerBlock || ""}

    <div class="section">
      <div class="sectionHead gradA">üåæ Bhav</div>
      <div class="sectionBody">

        <!-- ‚úÖ Favorites -->
        <div class="card" style="margin:0 0 10px 0;">
          <div style="font-weight:900;">‚≠ê Favorites</div>
          <div id="favWrap" style="margin-top:6px;"></div>
        </div>

        <div style="font-weight:900;font-size:15px;margin-bottom:8px;">‡§≠‡§æ‡§µ ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç</div>

        <div class="filters" style="margin:0;">
          <div class="seg">
            <button id="btnMW" class="active" type="button">Mandi Wise</button>
            <button id="btnFW" type="button">Fasal Wise</button>
          </div>

          <div id="mwBox" class="grid">
            <select id="mwState"><option value="">Select State</option></select>
            <select id="mwMandi"><option value="">Select Mandi</option></select>
          </div>

          <div id="fwBox" style="display:none;">
            <select id="fwFasal"><option value="">Select Fasal</option></select>
          </div>
        </div>

        <div id="selectionCard" class="card" style="display:none;font-weight:900;margin-top:10px;"></div>

        <div id="rowsBadge" class="rowsBadge" style="display:none;">
          <div>üìå Total rows found:</div>
          <div><b id="rowsCount">0</b></div>
        </div>

        <!-- ‚úÖ Full-width table -->
        <div id="bhavTableWrap" style="margin-top:10px;margin-left:-12px;margin-right:-12px;"></div>
      </div>
    </div>

    <div class="section">
      <div class="sectionHead gradC">üìä Quick Stats</div>
      <div class="sectionBody">
        <div class="statsGrid">
          <div class="statCard"><div class="statNum" id="statStates">0</div><div class="statLabel">Total States</div></div>
          <div class="statCard"><div class="statNum" id="statMandis">0</div><div class="statLabel">Total Mandis</div></div>
          <div class="statCard"><div class="statNum" id="statFasals">0</div><div class="statLabel">Total Fasals</div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sectionHead gradD">üîó Follow Us</div>
      <div class="sectionBody">
        <div class="socialGrid">
          <a class="socialBtn fb" target="_blank" href="https://www.facebook.com/todaymandirate">Facebook</a>
          <a class="socialBtn wa" target="_blank" href="https://whatsapp.com/channel/0029VaffzysDjiObzVBNpB3k">WhatsApp</a>
          <a class="socialBtn yt" target="_blank" href="https://youtube.com/todaymandirate">YouTube</a>
          <a class="socialBtn tg" target="_blank" href="https://t.me/todaymandirate">Telegram</a>
        </div>
      </div>
    </div>
  `;
}

let bhavMode="mandiWise";
function setBhavMode(m){
  bhavMode=m;
  document.getElementById("btnMW").classList.toggle("active", m==="mandiWise");
  document.getElementById("btnFW").classList.toggle("active", m==="fasalWise");
  document.getElementById("mwBox").style.display = (m==="mandiWise") ? "grid" : "none";
  document.getElementById("fwBox").style.display = (m==="fasalWise") ? "block" : "none";
  document.getElementById("bhavTableWrap").innerHTML="";
  document.getElementById("rowsBadge").style.display="none";
  setSelectionCard("");
}

/* selection card supports HTML */
function setSelectionCard(html){
  const c = document.getElementById("selectionCard");
  if(!c) return;
  if(!html){
    c.style.display="none";
    c.innerHTML="";
  }else{
    c.style.display="block";
    c.innerHTML=html;
  }
}

/* ‚úÖ Draw table implementations (with Load more) */
function drawMandiWise(rows){
  const wrap=document.getElementById("bhavTableWrap");
  const hasMore = currentRowsAll.length > rows.length;

  wrap.innerHTML = `
    <table><thead>
      <tr><th>Date</th><th>Fasal</th><th>Min</th><th>Max</th><th>Modal</th><th>Trend</th></tr>
    </thead><tbody>
      ${rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.Date||"")}</td><td>${escapeHtml(r.Fasal||"")}</td>
          <td>${escapeHtml(r.Min||"")}</td><td>${escapeHtml(r.Max||"")}</td><td>${escapeHtml(r.Modal||"")}</td>
          <td><span class="trendLink" data-mandi="${escapeHtml(r.Mandi||"")}" data-fasal="${escapeHtml(r.Fasal||"")}">${formatTrend(r.Trend||"")}</span></td>
        </tr>
      `).join("")}
    </tbody></table>
    ${hasMore ? `<div style="padding:12px;"><button class="miniBtn primary" type="button" onclick="loadMore()">Load more</button></div>` : ``}
  `;
  document.querySelectorAll("#bhavTableWrap .trendLink").forEach(c=>{
    c.onclick=()=>openTrend(c.dataset.mandi, c.dataset.fasal);
  });
}

function drawFasalWise(rows){
  const wrap=document.getElementById("bhavTableWrap");
  const hasMore = currentRowsAll.length > rows.length;

  wrap.innerHTML = `
    <table><thead>
      <tr><th>Date</th><th>Mandi</th><th>Min</th><th>Max</th><th>Modal</th><th>Trend</th></tr>
    </thead><tbody>
      ${rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.Date||"")}</td><td>${escapeHtml(r.Mandi||"")}</td>
          <td>${escapeHtml(r.Min||"")}</td><td>${escapeHtml(r.Max||"")}</td><td>${escapeHtml(r.Modal||"")}</td>
          <td><span class="trendLink" data-mandi="${escapeHtml(r.Mandi||"")}" data-fasal="${escapeHtml(r.Fasal||"")}">${formatTrend(r.Trend||"")}</span></td>
        </tr>
      `).join("")}
    </tbody></table>
    ${hasMore ? `<div style="padding:12px;"><button class="miniBtn primary" type="button" onclick="loadMore()">Load more</button></div>` : ``}
  `;
  document.querySelectorAll("#bhavTableWrap .trendLink").forEach(c=>{
    c.onclick=()=>openTrend(c.dataset.mandi, c.dataset.fasal);
  });
}

/* INIT */
async function init(){
  // ticker
  let tickerBlock = "";
  try{
    const t = await load("Ticker");
    const items = (t||[])
      .map(r=>getField(r,["Text","text","News","news","Title","title"]))
      .filter(Boolean)
      .slice(0,5);
    tickerBlock = tickerHTML(items);
  }catch(e){ tickerBlock=""; }

  bhav.innerHTML = bhavUI(tickerBlock);

  const btnMW=document.getElementById("btnMW");
  const btnFW=document.getElementById("btnFW");
  const mwState=document.getElementById("mwState");
  const mwMandi=document.getElementById("mwMandi");
  const fwFasal=document.getElementById("fwFasal");

  btnMW.onclick=()=>setBhavMode("mandiWise");
  btnFW.onclick=()=>setBhavMode("fasalWise");

  const b = await load("Bhav");
  bhavAll = (b||[]).map(r=>({
    Date: getField(r,["Date","date"]),
    DateISO: toISO(getField(r,["Date","date"])),
    State: getField(r,["State","state"]),
    Mandi: getField(r,["Mandi","mandi","MandiName"]),
    Fasal: getField(r,["Fasal","fasal","Crop"]),
    Min: getField(r,["Min","min"]),
    Max: getField(r,["Max","max"]),
    Modal: getField(r,["Modal","modal"]),
    Trend: getField(r,["Trend","trend"])
  })).filter(x=>x.Date || x.Mandi || x.Fasal);

  // favorites render
  renderFavs();

  // stats
  const states = unique(bhavAll.map(r=>r.State));
  const mandis = unique(bhavAll.map(r=>r.Mandi));
  const fasals = unique(bhavAll.map(r=>r.Fasal));
  animateCount(document.getElementById("statStates"), states.length);
  animateCount(document.getElementById("statMandis"), mandis.length);
  animateCount(document.getElementById("statFasals"), fasals.length);

  // fill dropdowns
  unique(bhavAll.map(r=>r.State)).forEach(s=> mwState.insertAdjacentHTML("beforeend", `<option>${escapeHtml(s)}</option>`));
  unique(bhavAll.map(r=>r.Fasal)).forEach(f=> fwFasal.insertAdjacentHTML("beforeend", `<option>${escapeHtml(f)}</option>`));

  mwState.onchange=()=>{
    mwMandi.innerHTML=`<option value="">Select Mandi</option>`;
    const s=mwState.value;
    unique(bhavAll.filter(r=>!s || r.State===s).map(r=>r.Mandi))
      .forEach(m=>mwMandi.insertAdjacentHTML("beforeend", `<option>${escapeHtml(m)}</option>`));
    document.getElementById("bhavTableWrap").innerHTML="";
    document.getElementById("rowsBadge").style.display="none";
    setSelectionCard("");
  };

  mwMandi.onchange=()=>{
    const s=mwState.value, m=mwMandi.value;
    if(!m){
      document.getElementById("bhavTableWrap").innerHTML="";
      document.getElementById("rowsBadge").style.display="none";
      setSelectionCard("");
      return;
    }

    setSelectionCard(
      `üìç Mandi: ${escapeHtml(m)}
       <button class="miniBtn" style="float:right;margin-left:8px;" onclick="addFav('mandi','${(m||"").replace(/'/g,"\\'")}')">‚≠ê Save</button>`
    );

    const rows = bhavAll
      .filter(r=>(!s || r.State===s) && r.Mandi===m)
      .sort((a,b)=> (b.DateISO||"").localeCompare(a.DateISO||""));

    resetPagination(rows, "mandiWise");
  };

  fwFasal.onchange=()=>{
    const f=fwFasal.value;
    if(!f){
      document.getElementById("bhavTableWrap").innerHTML="";
      document.getElementById("rowsBadge").style.display="none";
      setSelectionCard("");
      return;
    }

    setSelectionCard(`üåæ Fasal: ${escapeHtml(f)} <button class="miniBtn" style="float:right" onclick="addFav('fasal','${(f||"").replace(/'/g,"\\'")}')">‚≠ê Save</button>`);

    const rows = bhavAll
      .filter(r=>r.Fasal===f)
      .sort((a,b)=> (b.DateISO||"").localeCompare(a.DateISO||""));

    resetPagination(rows, "fasalWise");
  };

  setBhavMode("mandiWise");

  // ‚úÖ Onboarding (1-time)
  maybeShowOnboarding();

  // Other tabs
  const n=(await load("News")).reverse();
  news.innerHTML = `<div class="section"><div class="sectionHead gradB">üì∞ News</div><div class="sectionBody">${
    (n||[]).map((x,i)=>`
      <div class="card">
        <div class="row" onclick="openExclusive('newsDetail','n${i}')">
          <img src="${getField(x,["ImageURL","imageurl","Image","img"])||""}" onerror="this.style.display='none'">
          <div class="text">${escapeHtml(getField(x,["Title","title"])||"")}</div>
        </div>
        <div id="n${i}" class="detail newsDetail">${escapeHtml(getField(x,["Detail","detail","Full","full"])||"")}</div>
      </div>
    `).join("")
  }</div></div>`;

  const tr=(await load("Trend")).reverse();
  trend.innerHTML = `<div class="section"><div class="sectionHead gradE">üìà Teji/Mandi</div><div class="sectionBody">${
    (tr||[]).map((x,i)=>`
      <div class="card">
        <div class="row" onclick="openExclusive('trendDetail','t${i}')">
          <img src="${getField(x,["ImageURL","imageurl","Image","img"])||""}" onerror="this.style.display='none'">
          <div class="text">${escapeHtml(getField(x,["Title","title"])||"")}</div>
        </div>
        <div id="t${i}" class="detail trendDetail">${escapeHtml(getField(x,["Detail","detail","Full","full"])||"")}</div>
      </div>
    `).join("")
  }</div></div>`;

  const w=(await load("Weather")).reverse();
  weather.innerHTML = `<div class="section"><div class="sectionHead gradD">üå¶Ô∏è Mausam</div><div class="sectionBody">${
    (w||[]).map((x,i)=>`
      <div class="card">
        <div class="row" onclick="openExclusive('weatherDetail','w${i}')">
          <div class="text">${escapeHtml(getField(x,["Title","title"])||"")}</div>
        </div>
        <div id="w${i}" class="detail weatherDetail">${escapeHtml(getField(x,["Detail","detail","Full","full"])||"")}</div>
      </div>
    `).join("")
  }</div></div>`;

  const v=(await load("Video")).reverse();
  if(!v || v.length===0){
    video.innerHTML = `<div class="section"><div class="sectionHead gradB">üé• Video</div><div class="sectionBody"><div class="card">Video sheet empty ‡§π‡•à.</div></div></div>`;
  }else{
    video.innerHTML = `<div class="section"><div class="sectionHead gradB">üé• Video</div><div class="sectionBody">${
      v.map((x,i)=>{
        const title = getField(x,["Title","title","Name","name"]);
        const link  = getField(x,["VideoURL","videourl","VideoUrl","video","link","url","YouTubeLink","youtubelink"]);
        const id = ytId(link);
        if(!id) return `<div class="card"><b>${escapeHtml(title||"Video")}</b><div class="small">Invalid link</div></div>`;
        return `
          <div class="card">
            <div class="row" onclick="openVideo('${id}','${(title||"").replace(/'/g,"\\'")}')">
              <img src="https://img.youtube.com/vi/${id}/hqdefault.jpg" onerror="this.style.display='none'">
              <div class="text">${escapeHtml(title||"")}</div>
            </div>
          </div>
        `;
      }).join("")
    }</div></div>`;
  }
}

async function pollBhav(){
  setInterval(async ()=>{
    try{
      const b = await load("Bhav");
      const lastRow = (b && b.length) ? b[b.length-1] : null;
      const sig = lastRow ? JSON.stringify(lastRow) : "";
      const oldSig = localStorage.getItem("mg_last_bhav_sig") || "";
      if(sig && oldSig && sig !== oldSig){
        localStorage.setItem("mg_last_bhav_sig", sig);
        fireBhavUpdateAlert();
      }
      if(sig && !oldSig) localStorage.setItem("mg_last_bhav_sig", sig);

      // keep bhavAll refreshed for compare charts
      bhavAll = (b||[]).map(r=>({
        Date: getField(r,["Date","date"]),
        DateISO: toISO(getField(r,["Date","date"])),
        State: getField(r,["State","state"]),
        Mandi: getField(r,["Mandi","mandi","MandiName"]),
        Fasal: getField(r,["Fasal","fasal","Crop"]),
        Min: getField(r,["Min","min"]),
        Max: getField(r,["Max","max"]),
        Modal: getField(r,["Modal","modal"]),
        Trend: getField(r,["Trend","trend"])
      })).filter(x=>x.Date || x.Mandi || x.Fasal);

    }catch(e){}
  }, 300000);
}

init().then(pollBhav);
</script>
</body>
</html>
