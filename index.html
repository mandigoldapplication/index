<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Mandi GOLD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--bg:#0d0f12;--card:#111;--text:#fff;--brand:#0f9d58}
.light{--bg:#f4f4f4;--card:#fff;--text:#000}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
#splash{position:fixed;inset:0;background:#000;color:#FFD700;
display:flex;align-items:center;justify-content:center;font-size:30px;z-index:9999}
.tab{display:none;padding:12px;padding-bottom:90px}
.tab.active{display:block}
.bottom-nav{position:fixed;bottom:0;width:100%;display:flex;background:#111}
.bottom-nav button{flex:1;background:none;border:0;color:white;padding:8px;font-size:12px}
.card{display:flex;gap:10px;background:var(--card);padding:10px;border-radius:10px;margin-bottom:10px}
.card img{width:30%;border-radius:8px;object-fit:cover}
iframe{width:100%;height:220px;border-radius:10px;border:0}
select,input{width:48%;padding:6px;margin:4px 1%}
.toggle{position:fixed;top:10px;right:10px}
</style>
</head>
<body>

<div id="splash">ğŸŒ¾ Mandi GOLD</div>
<button class="toggle" onclick="toggleTheme()">ğŸŒ“</button>

<div id="bhav" class="tab"></div>
<div id="news" class="tab"></div>
<div id="trend" class="tab"></div>
<div id="mausam" class="tab"></div>
<div id="video" class="tab"></div>

<div class="bottom-nav">
<button onclick="showTab('bhav')">ğŸŒ¾ Bhav</button>
<button onclick="showTab('news')">ğŸ“° News</button>
<button onclick="showTab('trend')">ğŸ“ˆ Teji</button>
<button onclick="showTab('mausam')">ğŸŒ¦ï¸ Mausam</button>
<button onclick="showTab('video')">ğŸ¥ Video</button>
</div>

<script>
const SHEET_ID="1SX6L73WQ57OJ0tUUJwEjmSVgn3LjJLe54B4Lp_JN2SE";
const TABS=["bhav","news","trend","mausam","video"];

function showTab(t){
 TABS.forEach(x=>document.getElementById(x).classList.remove("active"));
 document.getElementById(t).classList.add("active");
 localStorage.setItem("tab",t);
}
showTab(localStorage.getItem("tab")||"bhav");

setTimeout(()=>splash.style.display="none",2000);
function toggleTheme(){document.body.classList.toggle("light")}

async function loadSheet(name){
 let r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${name}`);
 let text=await r.text();
 return JSON.parse(text.substr(47).slice(0,-2)).table.rows;
}

/* ---------------- BHAV ---------------- */
loadSheet("Bhav").then(rows=>{
 let data=rows.map(r=>({
   Date:r.c[0]?.v,
   State:r.c[1]?.v,
   District:r.c[2]?.v,
   Mandi:r.c[3]?.v,
   Fasal:r.c[4]?.v,
   Min:r.c[5]?.v,
   Max:r.c[6]?.v,
   Modal:r.c[7]?.v,
   Trend:r.c[8]?.v
 })).reverse();

 let latest=data[0]?.Date;
 if(localStorage.getItem("lastDate")!==latest){
   alert("ğŸ”” New Bhav Update!");
   localStorage.setItem("lastDate",latest);
 }

 bhav.innerHTML=`
<select id="state"></select>
<select id="district"></select>
<select id="mandi"></select>
<select id="fasal"></select>
<canvas id="chart"></canvas>
<div id="bhavList"></div>`;

 state.innerHTML=`<option>State</option>`+
 [...new Set(data.map(x=>x.State))].map(s=>`<option>${s}</option>`).join("");

 state.onchange=()=>{
   let ds=[...new Set(data.filter(x=>x.State==state.value).map(x=>x.District))];
   district.innerHTML=`<option>District</option>`+ds.map(x=>`<option>${x}</option>`).join("");
 }

 district.onchange=()=>{
   let ms=[...new Set(data.filter(x=>x.District==district.value).map(x=>x.Mandi))];
   mandi.innerHTML=`<option>Mandi</option>`+ms.map(x=>`<option>${x}</option>`).join("");
 }

 mandi.onchange=()=>{
   let fs=[...new Set(data.filter(x=>x.Mandi==mandi.value).map(x=>x.Fasal))];
   fasal.innerHTML=`<option>Fasal</option>`+fs.map(x=>`<option>${x}</option>`).join("");
 }

 fasal.onchange=()=>{
   let rows=data.filter(x=>x.Mandi==mandi.value && x.Fasal==fasal.value);
   bhavList.innerHTML=rows.map(r=>`
   <div class="card">
    <div>
     <b>${r.Date}</b><br>
     Min:${r.Min} Max:${r.Max} Modal:${r.Modal}<br>
     Trend:${r.Trend}
    </div>
   </div>`).join("");

   new Chart(chart,{type:"line",
    data:{labels:rows.map(r=>r.Date),
    datasets:[{label:"Modal",data:rows.map(r=>r.Modal),borderColor:"gold"}]}})
 }
});

/* ---------------- NEWS ---------------- */
loadSheet("News").then(rows=>{
 news.innerHTML=rows.reverse().map(r=>`
 <div class="card">
  <img src="${r.c[1]?.v}">
  <h4>${r.c[0]?.v}</h4>
 </div>`).join("");
});

/* ---------------- TEJI ---------------- */
loadSheet("TejiMandi").then(rows=>{
 trend.innerHTML=rows.reverse().map(r=>`
 <div class="card">
  <img src="${r.c[1]?.v}">
  <h4>${r.c[0]?.v}</h4>
 </div>`).join("");
});

/* ---------------- MAUSAM ---------------- */
loadSheet("Mausam").then(rows=>{
 mausam.innerHTML=rows.reverse().map(r=>`
 <div class="card">
  <h4>${r.c[0]?.v}</h4>
  <p>${r.c[1]?.v}</p>
 </div>`).join("");
});

/* ---------------- VIDEO ---------------- */
loadSheet("Video").then(rows=>{
 video.innerHTML=rows.reverse().map(r=>{
  let id=r.c[1]?.v.split("v=")[1]?.split("&")[0];
  return `<div class="card">
   <img src="https://img.youtube.com/vi/${id}/hqdefault.jpg"
    onclick="this.parentElement.innerHTML='<iframe src=https://www.youtube.com/embed/${id}?autoplay=1 allowfullscreen></iframe>'">
   <h4>${r.c[0]?.v}</h4>
  </div>`;
 }).join("");
});
</script>
</body>
</html>
