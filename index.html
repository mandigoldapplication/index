<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡§Æ‡§Ç‡§°‡•Ä GOLD</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f4f4; --card:#ffffff; --text:#111; --muted:#444;
  --green:#0f9d58; --border:#ddd; --gold:#FFD54A;
}
body.dark{
  --bg:#0d0f12; --card:#111; --text:#fff; --muted:#bfc6cc;
  --green:#0f9d58; --border:#2a2f36; --gold:#FFD54A;
}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);}

#splash{
  position:fixed; inset:0; background:var(--green); color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:28px; font-weight:900; z-index:9999;
}

header{
  background:var(--green); padding:12px 12px;
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
}
.brand{font-weight:900;letter-spacing:.5px;font-size:22px;line-height:1; white-space:nowrap;}
.brand .mandi{color:#fff;}
.brand .gold{color:var(--gold);text-shadow:0 1px 0 rgba(0,0,0,.3);}
.actions{display:flex;gap:8px;align-items:center;}
.btnSmall{
  background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25);
  color:#fff; padding:6px 10px; border-radius:999px;
  cursor:pointer; font-size:12px; font-weight:800;
}

.tab{display:none;padding:12px;padding-bottom:96px;}
.tab.active{display:block;}

/* ‚úÖ Premium section card (NO soft tint backgrounds) */
.section{
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--card);
  margin:14px 0;
  overflow:hidden;
}
.sectionHead{
  padding:10px 12px;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:8px;
  color:#fff;
}
.gradA{background:linear-gradient(90deg, #0f9d58, #1dbf73);}
.gradB{background:linear-gradient(90deg, #111827, #374151);}
.gradC{background:linear-gradient(90deg, #d97706, #f59e0b);}
.gradD{background:linear-gradient(90deg, #2563eb, #60a5fa);}
.gradE{background:linear-gradient(90deg, #7c3aed, #a78bfa);}
.sectionBody{padding:12px;}

.filters{background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px;margin:10px 0;}
.seg{display:flex;gap:8px;margin-bottom:10px;}
.seg button{
  flex:1; padding:10px; border-radius:10px; cursor:pointer;
  border:1px solid var(--border); background:var(--bg); color:var(--text); font-weight:800;
}
.seg button.active{background:var(--green);color:#fff;border-color:var(--green);}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
select{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
  background:var(--bg);color:var(--text);font-weight:700;
}

/* table */
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:10px;overflow:hidden;}
th,td{border:1px solid var(--border);padding:9px;font-size:13.5px;text-align:center;}
td{font-weight:600;}
th{background:var(--green);color:#fff;border-color:rgba(255,255,255,.2);font-weight:800;}

.card{background:var(--card);padding:10px;border-radius:10px;margin:10px 0;border:1px solid var(--border);}
.row{display:flex;gap:10px;align-items:center;cursor:pointer;}
.row img{width:30%;height:80px;object-fit:cover;border-radius:8px;background:#ccc;}
.row .text{width:70%;font-weight:700;font-size:14px}
.detail{display:none;font-size:14px;margin-top:8px;color:var(--muted);white-space:pre-wrap;font-weight:600;line-height:1.5;}

.bottom{
  position:fixed;bottom:0;left:0;right:0;
  display:flex;justify-content:space-around;
  background:var(--green); padding:6px 0;
}
.bottom button{
  flex:1;border:0;background:none;color:#fff;
  display:flex;flex-direction:column;align-items:center;gap:2px;
  font-size:11px;cursor:pointer;opacity:.92;
}
.bottom .icon{font-size:22px;line-height:1;}
.bottom button.active{opacity:1;color:#ffe082;font-weight:900;}

.trendLink{cursor:pointer;text-decoration:underline;font-weight:800;}

.modal{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:99999;
}
.modal .box{
  width:min(920px,92vw); max-height:86vh; overflow:auto;
  background:var(--bg); border:1px solid var(--border); border-radius:14px;
  padding:12px;
}
.modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.closeBtn{
  background:var(--card); border:1px solid var(--border); color:var(--text);
  padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800;
}
.small{font-size:12px;color:var(--muted);}
iframe{width:100%;height:240px;border-radius:12px;border:0;}
canvas{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px;}

#toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:88px; z-index:999999;
  background:var(--card); color:var(--text);
  border:1px solid var(--border);
  padding:10px 12px; border-radius:999px;
  display:none; font-weight:900; box-shadow:0 6px 20px rgba(0,0,0,.2);
}

/* ticker */
.tickerWrap{
  margin:10px 0 6px 0;
  border:1px solid var(--border);
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  align-items:center;
}
.tickerLabel{
  background:var(--green);
  color:var(--gold);
  font-weight:900;
  padding:10px 12px;
  white-space:nowrap;
}
.marquee{position:relative;overflow:hidden;width:100%;padding:10px 0;}
.track{display:inline-block;white-space:nowrap;will-change:transform;animation: scroll 18s linear infinite;}
.track span{margin:0 14px;font-weight:700;color:var(--text);}
@keyframes scroll{0%{transform:translateX(0);}100%{transform:translateX(-50%);}}

/* stats */
.statsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.statCard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;}
.statNum{font-size:20px;font-weight:900;line-height:1.2;}
.statLabel{font-size:12px;color:var(--muted);font-weight:700;margin-top:4px;}

/* socials */
.socialGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.socialBtn{
  display:flex;align-items:center;justify-content:center;
  padding:10px;border-radius:10px;text-decoration:none;
  font-weight:900;color:#fff;
}
.fb{background:#1877F2;}
.wa{background:#25D366;}
.yt{background:#FF0000;}
.tg{background:#229ED9;}

/* ‚úÖ Total rows found badge */
.rowsBadge{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background:var(--bg);
  border:1px dashed var(--border);
  border-radius:12px;
  padding:10px 12px;
  margin:10px 0 0 0;
  font-weight:800;
}
.rowsBadge b{font-weight:900;}
</style>
</head>

<body>
<div id="splash">üåæ ‡§Æ‡§Ç‡§°‡•Ä GOLD</div>
<div id="toast"></div>

<header>
  <div class="brand"><span class="mandi">‡§Æ‡§Ç‡§°‡•Ä</span> <span class="gold">GOLD</span></div>
  <div class="actions">
    <button class="btnSmall" onclick="enableAlerts()">üîî Alerts</button>
    <button class="btnSmall" onclick="toggleTheme()">üåó Theme</button>
  </div>
</header>

<div id="bhav" class="tab active"></div>
<div id="news" class="tab"></div>
<div id="trend" class="tab"></div>
<div id="weather" class="tab"></div>
<div id="video" class="tab"></div>

<div class="bottom">
  <button id="btn-bhav" onclick="openTab('bhav')"><div class="icon">üåæ</div><div>Bhav</div></button>
  <button id="btn-news" onclick="openTab('news')"><div class="icon">üì∞</div><div>News</div></button>
  <button id="btn-trend" onclick="openTab('trend')"><div class="icon">üìà</div><div>Teji/Mandi</div></button>
  <button id="btn-weather" onclick="openTab('weather')"><div class="icon">üå¶Ô∏è</div><div>Mausam</div></button>
  <button id="btn-video" onclick="openTab('video')"><div class="icon">üé•</div><div>Video</div></button>
</div>

<!-- Trend Modal -->
<div id="trendModal" class="modal">
  <div class="box">
    <div class="modalTop">
      <div style="font-weight:900;font-size:16px;" id="trendTitle">üìä Trend</div>
      <button class="closeBtn" onclick="closeTrend()">‚úñ Close</button>
    </div>
    <div class="card" style="margin:0 0 10px 0;">
      <div style="font-weight:900;margin-bottom:6px;">Last 7 Days (Modal)</div>
      <canvas id="chart7" height="120"></canvas>
    </div>
    <div class="card" style="margin:0;">
      <div style="font-weight:900;margin-bottom:6px;">Last 30 Days (Modal)</div>
      <canvas id="chart30" height="120"></canvas>
    </div>
  </div>
</div>

<!-- Video Modal -->
<div id="videoModal" class="modal">
  <div class="box">
    <div class="modalTop">
      <div style="font-weight:900;font-size:16px;" id="videoTitle">üé• Video</div>
      <button class="closeBtn" onclick="closeVideo()">‚úñ Close</button>
    </div>
    <div id="videoFrameWrap"></div>
  </div>
</div>

<script>
/* THEME */
document.body.classList.remove("dark");
if(localStorage.theme === "dark") document.body.classList.add("dark");
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.theme = document.body.classList.contains("dark") ? "dark" : "light";
}

/* SPLASH */
(function(){
  const seen = localStorage.getItem("mg_splash_seen");
  const s = document.getElementById("splash");
  if(seen){ s.style.display="none"; }
  else{
    setTimeout(()=>{ s.style.display="none"; localStorage.setItem("mg_splash_seen","1"); },2000);
  }
})();

/* CONFIG */
const SHEET_ID="1SX6L73WQ57OJ0tUUJwEjmSVgn3LjJLe54B4Lp_JN2SE";

/* TABS */
function closeVideo(){
  document.getElementById("videoFrameWrap").innerHTML = "";
  document.getElementById("videoModal").style.display = "none";
}
function openTab(t){
  const current = localStorage.tab || "bhav";
  if(current === "video" && t !== "video"){ closeVideo(); }

  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById(t).classList.add('active');

  document.querySelectorAll('.bottom button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+t).classList.add('active');

  localStorage.tab=t;
}
if(localStorage.tab) openTab(localStorage.tab); else openTab("bhav");

/* LOAD */
async function load(sheet){
  const r = await fetch(`https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheet)}`);
  return r.json();
}

/* HELPERS */
function unique(arr){return [...new Set(arr.filter(x=>x!==undefined && x!==null && x!==""))];}
function toISO(dateStr){
  const d=new Date((dateStr||"").toString().trim());
  if(isNaN(d.getTime())) return "";
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function getField(obj, names){
  const keys = Object.keys(obj||{});
  for(const name of names){
    const k = keys.find(x => x.toLowerCase() === name.toLowerCase());
    if(k) return obj[k];
  }
  return "";
}
function formatTrend(val){
  const s=(val||"").toString().trim().toLowerCase();
  if(!s) return "";
  if(s.startsWith("teji")){
    const n = (s.match(/\d+/)||[""])[0];
    return `üü¢ +${n || ""}`;
  }
  if(s.startsWith("mandi")){
    const n = (s.match(/\d+/)||[""])[0];
    return `üî¥-${n || ""}`;
  }
  if(s.startsWith("neutral")) return `üü† Neutral`;
  return val;
}
function openExclusive(group, id){
  document.querySelectorAll(`.${group}`).forEach(el=>{
    if(el.id !== id) el.style.display="none";
  });
  const t=document.getElementById(id);
  if(!t) return;
  t.style.display = (t.style.display==="block") ? "none" : "block";
}
function escapeHtml(str){
  return (str||"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* TOAST + ALERTS (in-app only) */
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  setTimeout(()=>t.style.display="none", 4500);
}
function enableAlerts(){
  localStorage.setItem("mg_alerts_enabled","1");
  showToast("‚úÖ Alerts ON (In-app)");
}
function fireBhavUpdateAlert(){
  const enabled = localStorage.getItem("mg_alerts_enabled")==="1";
  const msg="‡§®‡§Ø‡•á ‡§≠‡§æ‡§µ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡§Ç, ‡§Ö‡§™‡§®‡•Ä ‡§Æ‡§Ç‡§°‡•Ä ‡§ï‡•á ‡§®‡§è üåæ ‡§≠‡§æ‡§µ ‡§ú‡§æ‡§®‡§ø‡§è ‡§Ö‡§≠‡•Ä";
  if(enabled){
    showToast("üîî " + msg);
    if(navigator.vibrate) navigator.vibrate([120, 60, 120]);
  }
}

/* TICKER */
function tickerHTML(items){
  if(!items || items.length===0) return "";
  const line = items.map(x=>`<span>‚Ä¢ ${escapeHtml(x)}</span>`).join("");
  return `
    <div class="tickerWrap">
      <div class="tickerLabel">Latest</div>
      <div class="marquee">
        <div class="track">${line}${line}</div>
      </div>
    </div>
  `;
}

/* STATS COUNTER (3 sec) */
function animateCount(el, target){
  if(!el) return;
  let cur = 0;
  const duration = 3000, fps = 30;
  const totalSteps = Math.max(1, Math.floor((duration/1000)*fps));
  const stepVal = target / totalSteps;

  const timer = setInterval(()=>{
    cur += stepVal;
    if(cur >= target){
      cur = target;
      clearInterval(timer);
    }
    el.textContent = Math.round(cur);
  }, Math.round(1000/fps));
}

/* YOUTUBE */
function ytId(url){
  if(!url) return "";
  const u=url.toString().trim();
  if(u.includes("youtu.be/")) return u.split("youtu.be/")[1].split("?")[0].split("&")[0];
  if(u.includes("watch?v=")) return u.split("watch?v=")[1].split("&")[0];
  if(u.includes("/shorts/")) return u.split("/shorts/")[1].split("?")[0].split("&")[0];
  return "";
}
function openVideo(id, title){
  document.getElementById("videoTitle").textContent = "üé• " + (title || "Video");
  const src = `https://www.youtube.com/embed/${id}?autoplay=1&playsinline=1&rel=0`;
  document.getElementById("videoFrameWrap").innerHTML =
    `<iframe src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
  document.getElementById("videoModal").style.display="flex";
}

/* TREND CHART */
let bhavAll=[];
let chart7Inst=null, chart30Inst=null;

function closeTrend(){
  document.getElementById("trendModal").style.display="none";
  if(chart7Inst){chart7Inst.destroy(); chart7Inst=null;}
  if(chart30Inst){chart30Inst.destroy(); chart30Inst=null;}
}
function lastN(arr,n){return arr.slice(Math.max(0, arr.length-n));}
function openTrend(mandi, fasal){
  document.getElementById("trendTitle").textContent = `üìä Trend: ${mandi || ""}${fasal ? " | "+fasal : ""}`;
  const rows = bhavAll
    .filter(r => (!mandi || r.Mandi===mandi) && (!fasal || r.Fasal===fasal))
    .sort((a,b)=> (a.DateISO||"").localeCompare(b.DateISO||""));
  const rows7 = lastN(rows, 7);
  const rows30 = lastN(rows, 30);

  const ctx7 = document.getElementById("chart7").getContext("2d");
  const ctx30 = document.getElementById("chart30").getContext("2d");

  chart7Inst = new Chart(ctx7,{
    type:"line",
    data:{labels: rows7.map(r=>r.Date),
      datasets:[{data: rows7.map(r=>Number(r.Modal||0)),
        borderColor:"#0f9d58", backgroundColor:"rgba(15,157,88,0.12)", tension:0.25, fill:true}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });

  chart30Inst = new Chart(ctx30,{
    type:"line",
    data:{labels: rows30.map(r=>r.Date),
      datasets:[{data: rows30.map(r=>Number(r.Modal||0)),
        borderColor:"#FFD54A", backgroundColor:"rgba(255,213,74,0.12)", tension:0.25, fill:true}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });

  document.getElementById("trendModal").style.display="flex";
}

/* ‚úÖ Total rows found */
function setRowsFound(n){
  const badge = document.getElementById("rowsBadge");
  const count = document.getElementById("rowsCount");
  if(!badge || !count) return;
  badge.style.display = "flex";
  count.textContent = n;
}

/* BHAV UI */
function bhavUI(tickerBlock){
  return `
    ${tickerBlock || ""}

    <div class="section">
      <div class="sectionHead gradA">üåæ Bhav</div>
      <div class="sectionBody">

        <div style="font-weight:900;font-size:15px;margin-bottom:8px;">‡§≠‡§æ‡§µ ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç</div>

        <div class="filters" style="margin:0;">
          <div class="seg">
            <button id="btnMW" class="active" type="button">Mandi Wise</button>
            <button id="btnFW" type="button">Fasal Wise</button>
          </div>

          <div id="mwBox" class="grid">
            <select id="mwState"><option value="">Select State</option></select>
            <select id="mwMandi"><option value="">Select Mandi</option></select>
          </div>

          <div id="fwBox" style="display:none;">
            <select id="fwFasal"><option value="">Select Fasal</option></select>
          </div>
        </div>

        <div id="selectionCard" class="card" style="display:none;font-weight:900;margin-top:10px;"></div>

        <div id="rowsBadge" class="rowsBadge" style="display:none;">
          <div>üìå Total rows found:</div>
          <div><b id="rowsCount">0</b></div>
        </div>

        <div id="bhavTableWrap" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="section">
      <div class="sectionHead gradC">üìä Quick Stats</div>
      <div class="sectionBody">
        <div class="statsGrid">
          <div class="statCard"><div class="statNum" id="statStates">0</div><div class="statLabel">Total States</div></div>
          <div class="statCard"><div class="statNum" id="statMandis">0</div><div class="statLabel">Total Mandis</div></div>
          <div class="statCard"><div class="statNum" id="statFasals">0</div><div class="statLabel">Total Fasals</div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sectionHead gradD">üîó Follow Us</div>
      <div class="sectionBody">
        <div class="socialGrid">
          <a class="socialBtn fb" target="_blank" href="https://www.facebook.com/todaymandirate">Facebook</a>
          <a class="socialBtn wa" target="_blank" href="https://whatsapp.com/channel/0029VaffzysDjiObzVBNpB3k">WhatsApp</a>
          <a class="socialBtn yt" target="_blank" href="https://youtube.com/todaymandirate">YouTube</a>
          <a class="socialBtn tg" target="_blank" href="https://t.me/todaymandirate">Telegram</a>
        </div>
      </div>
    </div>
  `;
}

let bhavMode="mandiWise";
function setBhavMode(m){
  bhavMode=m;
  document.getElementById("btnMW").classList.toggle("active", m==="mandiWise");
  document.getElementById("btnFW").classList.toggle("active", m==="fasalWise");
  document.getElementById("mwBox").style.display = (m==="mandiWise") ? "grid" : "none";
  document.getElementById("fwBox").style.display = (m==="fasalWise") ? "block" : "none";
  document.getElementById("bhavTableWrap").innerHTML="";
  document.getElementById("rowsBadge").style.display="none";
  setSelectionCard("");
}
function setSelectionCard(text){
  const c = document.getElementById("selectionCard");
  if(!c) return;
  if(!text){
    c.style.display="none";
    c.textContent="";
  }else{
    c.style.display="block";
    c.textContent=text;
  }
}

function renderBhavTableMandiWise(rows){
  setRowsFound(rows.length);
  const wrap=document.getElementById("bhavTableWrap");
  wrap.innerHTML = `
    <table><thead>
      <tr><th>Date</th><th>Fasal</th><th>Min</th><th>Max</th><th>Modal</th><th>Trend</th></tr>
    </thead><tbody>
      ${rows.map(r=>`
        <tr>
          <td>${r.Date||""}</td><td>${r.Fasal||""}</td>
          <td>${r.Min||""}</td><td>${r.Max||""}</td><td>${r.Modal||""}</td>
          <td class="trendLink" data-mandi="${r.Mandi||""}" data-fasal="${r.Fasal||""}">${formatTrend(r.Trend||"")}</td>
        </tr>
      `).join("")}
    </tbody></table>
  `;
  document.querySelectorAll("#bhavTableWrap .trendLink").forEach(c=>{
    c.onclick=()=>openTrend(c.dataset.mandi, c.dataset.fasal);
  });
}

function renderBhavTableFasalWise(rows){
  setRowsFound(rows.length);
  const wrap=document.getElementById("bhavTableWrap");
  wrap.innerHTML = `
    <table><thead>
      <tr><th>Date</th><th>Mandi</th><th>Min</th><th>Max</th><th>Modal</th><th>Trend</th></tr>
    </thead><tbody>
      ${rows.map(r=>`
        <tr>
          <td>${r.Date||""}</td><td>${r.Mandi||""}</td>
          <td>${r.Min||""}</td><td>${r.Max||""}</td><td>${r.Modal||""}</td>
          <td class="trendLink" data-mandi="${r.Mandi||""}" data-fasal="${r.Fasal||""}">${formatTrend(r.Trend||"")}</td>
        </tr>
      `).join("")}
    </tbody></table>
  `;
  document.querySelectorAll("#bhavTableWrap .trendLink").forEach(c=>{
    c.onclick=()=>openTrend(c.dataset.mandi, c.dataset.fasal);
  });
}

/* INIT */
async function init(){
  // ticker
  let tickerBlock = "";
  try{
    const t = await load("Ticker");
    const items = (t||[])
      .map(r=>getField(r,["Text","text","News","news","Title","title"]))
      .filter(Boolean)
      .slice(0,5);
    tickerBlock = tickerHTML(items);
  }catch(e){ tickerBlock=""; }

  bhav.innerHTML = bhavUI(tickerBlock);

  const btnMW=document.getElementById("btnMW");
  const btnFW=document.getElementById("btnFW");
  const mwState=document.getElementById("mwState");
  const mwMandi=document.getElementById("mwMandi");
  const fwFasal=document.getElementById("fwFasal");

  btnMW.onclick=()=>setBhavMode("mandiWise");
  btnFW.onclick=()=>setBhavMode("fasalWise");

  const b = await load("Bhav");
  bhavAll = b.map(r=>({
    Date: getField(r,["Date","date"]),
    DateISO: toISO(getField(r,["Date","date"])),
    State: getField(r,["State","state"]),
    Mandi: getField(r,["Mandi","mandi","MandiName"]),
    Fasal: getField(r,["Fasal","fasal","Crop"]),
    Min: getField(r,["Min","min"]),
    Max: getField(r,["Max","max"]),
    Modal: getField(r,["Modal","modal"]),
    Trend: getField(r,["Trend","trend"])
  })).filter(x=>x.Date || x.Mandi || x.Fasal);

  // stats
  const states = unique(bhavAll.map(r=>r.State));
  const mandis = unique(bhavAll.map(r=>r.Mandi));
  const fasals = unique(bhavAll.map(r=>r.Fasal));
  animateCount(document.getElementById("statStates"), states.length);
  animateCount(document.getElementById("statMandis"), mandis.length);
  animateCount(document.getElementById("statFasals"), fasals.length);

  // fill dropdowns
  unique(bhavAll.map(r=>r.State)).forEach(s=> mwState.insertAdjacentHTML("beforeend", `<option>${escapeHtml(s)}</option>`));
  unique(bhavAll.map(r=>r.Fasal)).forEach(f=> fwFasal.insertAdjacentHTML("beforeend", `<option>${escapeHtml(f)}</option>`));

  mwState.onchange=()=>{
    mwMandi.innerHTML=`<option value="">Select Mandi</option>`;
    const s=mwState.value;
    unique(bhavAll.filter(r=>!s || r.State===s).map(r=>r.Mandi))
      .forEach(m=>mwMandi.insertAdjacentHTML("beforeend", `<option>${escapeHtml(m)}</option>`));
    document.getElementById("bhavTableWrap").innerHTML="";
    document.getElementById("rowsBadge").style.display="none";
    setSelectionCard("");
  };

  mwMandi.onchange=()=>{
    const s=mwState.value, m=mwMandi.value;
    if(!m){ document.getElementById("bhavTableWrap").innerHTML=""; document.getElementById("rowsBadge").style.display="none"; setSelectionCard(""); return; }
    setSelectionCard(`üìç Mandi: ${m}`);
    const rows = bhavAll
      .filter(r=>(!s || r.State===s) && r.Mandi===m)
      .sort((a,b)=> (b.DateISO||"").localeCompare(a.DateISO||""));
    renderBhavTableMandiWise(rows);
  };

  fwFasal.onchange=()=>{
    const f=fwFasal.value;
    if(!f){ document.getElementById("bhavTableWrap").innerHTML=""; document.getElementById("rowsBadge").style.display="none"; setSelectionCard(""); return; }
    setSelectionCard(`üåæ Fasal: ${f}`);
    const rows = bhavAll
      .filter(r=>r.Fasal===f)
      .sort((a,b)=> (b.DateISO||"").localeCompare(a.DateISO||""));
    renderBhavTableFasalWise(rows);
  };

  setBhavMode("mandiWise");

  // Other tabs
  const n=(await load("News")).reverse();
  news.innerHTML = `<div class="section"><div class="sectionHead gradB">üì∞ News</div><div class="sectionBody">${
    n.map((x,i)=>`
      <div class="card">
        <div class="row" onclick="openExclusive('newsDetail','n${i}')">
          <img src="${getField(x,["ImageURL","imageurl","Image","img"])||""}" onerror="this.style.display='none'">
          <div class="text">${escapeHtml(getField(x,["Title","title"])||"")}</div>
        </div>
        <div id="n${i}" class="detail newsDetail">${escapeHtml(getField(x,["Detail","detail","Full","full"])||"")}</div>
      </div>
    `).join("")
  }</div></div>`;

  const tr=(await load("Trend")).reverse();
  trend.innerHTML = `<div class="section"><div class="sectionHead gradE">üìà Teji/Mandi</div><div class="sectionBody">${
    tr.map((x,i)=>`
      <div class="card">
        <div class="row" onclick="openExclusive('trendDetail','t${i}')">
          <img src="${getField(x,["ImageURL","imageurl","Image","img"])||""}" onerror="this.style.display='none'">
          <div class="text">${escapeHtml(getField(x,["Title","title"])||"")}</div>
        </div>
        <div id="t${i}" class="detail trendDetail">${escapeHtml(getField(x,["Detail","detail","Full","full"])||"")}</div>
      </div>
    `).join("")
  }</div></div>`;

  const w=(await load("Weather")).reverse();
  weather.innerHTML = `<div class="section"><div class="sectionHead gradD">üå¶Ô∏è Mausam</div><div class="sectionBody">${
    w.map((x,i)=>`
      <div class="card">
        <div class="row" onclick="openExclusive('weatherDetail','w${i}')">
          <div class="text">${escapeHtml(getField(x,["Title","title"])||"")}</div>
        </div>
        <div id="w${i}" class="detail weatherDetail">${escapeHtml(getField(x,["Detail","detail","Full","full"])||"")}</div>
      </div>
    `).join("")
  }</div></div>`;

  const v=(await load("Video")).reverse();
  if(!v || v.length===0){
    video.innerHTML = `<div class="section"><div class="sectionHead gradB">üé• Video</div><div class="sectionBody"><div class="card">Video sheet empty ‡§π‡•à.</div></div></div>`;
  }else{
    video.innerHTML = `<div class="section"><div class="sectionHead gradB">üé• Video</div><div class="sectionBody">${
      v.map((x,i)=>{
        const title = getField(x,["Title","title","Name","name"]);
        const link  = getField(x,["VideoURL","videourl","VideoUrl","video","link","url","YouTubeLink","youtubelink"]);
        const id = ytId(link);
        if(!id) return `<div class="card"><b>${escapeHtml(title||"Video")}</b><div class="small">Invalid link</div></div>`;
        return `
          <div class="card">
            <div class="row" onclick="openVideo('${id}','${(title||"").replace(/'/g,"\\'")}')">
              <img src="https://img.youtube.com/vi/${id}/hqdefault.jpg" onerror="this.style.display='none'">
              <div class="text">${escapeHtml(title||"")}</div>
            </div>
          </div>
        `;
      }).join("")
    }</div></div>`;
  }
}

async function pollBhav(){
  setInterval(async ()=>{
    try{
      const b = await load("Bhav");
      const lastRow = (b && b.length) ? b[b.length-1] : null;
      const sig = lastRow ? JSON.stringify(lastRow) : "";
      const oldSig = localStorage.getItem("mg_last_bhav_sig") || "";
      if(sig && oldSig && sig !== oldSig){
        localStorage.setItem("mg_last_bhav_sig", sig);
        fireBhavUpdateAlert();
      }
      if(sig && !oldSig) localStorage.setItem("mg_last_bhav_sig", sig);
    }catch(e){}
  }, 300000);
}

init().then(pollBhav);
</script>
</body>
</html>
